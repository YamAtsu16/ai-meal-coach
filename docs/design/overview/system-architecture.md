# システムアーキテクチャ

[← 設計書トップに戻る](../README.md) | [← システム概要](./system-overview.md)

## 1. 技術スタック

### 1.1 フロントエンド

| 技術 | バージョン | 用途 |
|------|-----------|------|
| **Next.js** | 15.2.3 | Reactベースのフルスタックフレームワーク |
| **React** | 19.0.0 | UIライブラリ |
| **TypeScript** | 5.x | 型安全な開発言語 |
| **Tailwind CSS** | 4.x | ユーティリティファーストCSSフレームワーク |
| **Framer Motion** | 12.6.3 | アニメーションライブラリ |
| **React Hook Form** | 7.54.2 | フォーム管理ライブラリ |
| **Zod** | 3.24.2 | スキーマバリデーションライブラリ |
| **Recharts** | 2.15.1 | チャート・グラフライブラリ |

### 1.2 バックエンド

| 技術 | バージョン | 用途 |
|------|-----------|------|
| **Next.js API Routes** | 15.2.3 | サーバーサイドAPI |
| **NextAuth.js** | 4.24.11 | 認証システム |
| **MongoDB** | 6.15.0 | ドキュメント指向データベース |
| **bcryptjs** | 3.0.2 | パスワードハッシュ化 |

### 1.3 AI・外部API

| サービス | バージョン | 用途 |
|----------|-----------|------|
| **OpenAI API** | 4.89.0 | GPT-4o-mini による栄養分析 |
| **Edamam Food Database API** | - | 食品栄養情報検索 |
| **DeepL API** | - | 多言語対応（翻訳機能） |

### 1.4 開発・テスト

| 技術 | バージョン | 用途 |
|------|-----------|------|
| **Jest** | 29.7.0 | テストフレームワーク |
| **Testing Library** | - | コンポーネントテスト |
| **ESLint** | 9.x | 静的解析ツール |

## 2. アーキテクチャ構成

### 2.1 レイヤー構成

```
┌─────────────────────────────────────────────────────────────┐
│                    クライアント層                              │
│  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐         │
│  │  Web UI     │ │  Mobile UI  │ │  PWA        │         │
│  │ (Next.js)   │ │(Responsive) │ │             │         │
│  └─────────────┘ └─────────────┘ └─────────────┘         │
└─────────────────────────────────────────────────────────────┘
                           │
┌─────────────────────────────────────────────────────────────┐
│                   アプリケーション層                           │
│  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐         │
│  │  Pages      │ │ Components  │ │   Hooks     │         │
│  │             │ │             │ │             │         │
│  └─────────────┘ └─────────────┘ └─────────────┘         │
│  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐         │
│  │ Providers   │ │   Utils     │ │   Types     │         │
│  │             │ │             │ │             │         │
│  └─────────────┘ └─────────────┘ └─────────────┘         │
└─────────────────────────────────────────────────────────────┘
                           │
┌─────────────────────────────────────────────────────────────┐
│                      API層                                  │
│  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐         │
│  │    Auth     │ │    Meals    │ │   Profile   │         │
│  │             │ │             │ │             │         │
│  └─────────────┘ └─────────────┘ └─────────────┘         │
│  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐         │
│  │  Analysis   │ │ Food Search │ │ Middleware  │         │
│  │             │ │             │ │             │         │
│  └─────────────┘ └─────────────┘ └─────────────┘         │
└─────────────────────────────────────────────────────────────┘
                           │
┌─────────────────────────────────────────────────────────────┐
│                    データ層                                 │
│  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐         │
│  │   MongoDB   │ │  OpenAI     │ │   Edamam    │         │
│  │  Database   │ │     API     │ │     API     │         │
│  └─────────────┘ └─────────────┘ └─────────────┘         │
└─────────────────────────────────────────────────────────────┘
```

### 2.2 データフロー

```
ユーザー操作
    ↓
Next.js Pages (SSR/CSR)
    ↓
React Components
    ↓
Custom Hooks (状態管理)
    ↓
API Routes (Next.js)
    ↓
Business Logic
    ↓
External APIs / MongoDB
    ↓
Response Processing
    ↓
UI Update
```

## 3. プロジェクト構造

### 3.1 ディレクトリ構成

```
ai-meal-coach/
├── public/                 # 静的アセット
├── src/                    # ソースコード
│   ├── app/                # Next.js アプリケーションルーター
│   │   ├── (pages)/        # ページコンポーネント
│   │   ├── api/            # APIルート
│   │   ├── globals.css     # グローバルスタイル
│   │   └── layout.tsx      # ルートレイアウト
│   ├── components/         # Reactコンポーネント
│   │   ├── common/         # 共通コンポーネント
│   │   │   ├── layout/     # レイアウト関連
│   │   │   └── ui/         # UI基本コンポーネント
│   │   └── features/       # 機能別コンポーネント
│   │       ├── analysis/   # 栄養分析関連
│   │       └── meal/       # 食事記録関連
│   ├── lib/                # ユーティリティ・ヘルパー
│   │   ├── constants/      # 定数定義
│   │   ├── hooks/          # カスタムフック
│   │   ├── types/          # 型定義
│   │   │   ├── common/     # 共通型
│   │   │   ├── external/   # 外部API型
│   │   │   └── features/   # 機能別型
│   │   └── utils/          # ユーティリティ関数
│   ├── middleware.ts       # Next.js ミドルウェア
│   └── providers/          # コンテキストプロバイダー
├── __tests__/              # テストファイル
├── docs/                   # ドキュメント
├── .env.example            # 環境変数テンプレート
├── package.json            # 依存関係・スクリプト
├── tailwind.config.ts      # Tailwind CSS設定
└── tsconfig.json           # TypeScript設定
```

### 3.2 コンポーネント設計原則

#### 3.2.1 階層構造
- **Pages**: ルーティング・レイアウト
- **Features**: 機能別コンポーネント（ビジネスロジック含む）
- **Common**: 再利用可能な汎用コンポーネント
- **UI**: 基本的なUIコンポーネント

#### 3.2.2 責務分離
- **Presentation**: UI表示のみ
- **Container**: 状態管理・ビジネスロジック
- **Hooks**: 再利用可能なロジック
- **Utils**: 純粋関数・ヘルパー

## 4. 技術選定理由

### 4.1 Next.js採用理由
- **フルスタック開発**: フロントエンド・バックエンドの統合
- **TypeScript統合**: 型安全性の確保
- **パフォーマンス**: 自動最適化・コード分割
- **開発体験**: Hot Reload・デバッグ支援

### 4.2 MongoDB採用理由
- **柔軟なスキーマ**: 食事記録の半構造化データに適合
- **スケーラビリティ**: 将来的な拡張に対応
- **開発効率**: JSONライクなデータ操作
- **クラウド対応**: MongoDB Atlasとの親和性

### 4.3 AI・外部API選定理由

#### OpenAI API
- **高品質な自然言語処理**: GPT-4o-miniの優れた理解力
- **専門知識の活用**: プロンプトエンジニアリングによる栄養学知識の注入
- **日本語対応**: 日本語での自然な対話

#### Edamam Food Database API
- **豊富な食品データ**: 包括的な栄養情報
- **信頼性**: 科学的根拠に基づくデータ
- **API安定性**: 商用レベルの可用性

## 5. 非機能要件

### 5.1 パフォーマンス
- **ページ読み込み時間**: < 3秒
- **API応答時間**: < 500ms
- **バンドルサイズ**: 最適化による軽量化

### 5.2 可用性
- **アップタイム**: > 99.5%
- **エラー率**: < 1%
- **復旧時間**: < 1時間

### 5.3 セキュリティ
- **認証**: JWT + NextAuth.js
- **データ暗号化**: HTTPS通信
- **入力検証**: Zodスキーマバリデーション

### 5.4 スケーラビリティ
- **水平スケーリング**: MongoDB Atlasクラスター
- **CDN対応**: 静的アセットの配信最適化
- **キャッシング**: ブラウザ・サーバーサイドキャッシュ

## 6. 開発環境

### 6.1 必要な環境
- **Node.js**: 18.x以上
- **npm**: 9.x以上
- **MongoDB**: ローカル環境またはAtlas

### 6.2 開発ツール
- **IDE**: VS Code推奨
- **拡張機能**: TypeScript、Tailwind CSS、ESLint
- **デバッグ**: Next.js Dev Tools、React Developer Tools

### 6.3 環境変数
```bash
# データベース
DATABASE_URL=mongodb://localhost:27017/ai-meal-coach

# 認証
NEXTAUTH_SECRET=your-secret-key
NEXTAUTH_URL=http://localhost:3000

# 外部API
OPENAI_API_KEY=your-openai-api-key
EDAMAM_APP_ID=your-edamam-app-id
EDAMAM_APP_KEY=your-edamam-app-key
DEEPL_API_KEY=your-deepl-api-key
```

## 7. 今後の技術的改善

### 7.1 短期改善
- **PWA対応**: オフライン機能の追加
- **パフォーマンス最適化**: 画像最適化・レイジーローディング
- **エラー監視**: Sentry等の導入

### 7.2 中期改善
- **マイクロサービス化**: 機能別サービス分離
- **リアルタイム機能**: WebSocket導入
- **CDN導入**: グローバル配信最適化

### 7.3 長期改善
- **多言語対応**: i18n実装
- **モバイルアプリ**: React Native展開
- **AI機能強化**: 独自モデルの開発

---

## 関連ドキュメント

- [システム概要](./system-overview.md) - アプリケーション概要
- [データベース設計](../technical/database-design.md) - データ構造の詳細
- [API設計](../technical/api-design.md) - エンドポイント仕様
- [セキュリティ設計](../technical/security-design.md) - セキュリティ対策

**最終更新**: 2024年1月  
**作成者**: AI Assistant
